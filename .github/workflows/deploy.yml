name: ci-cd-api-ia

on:
  push:
    branches: [ main ]
    paths:
      - 'app.js'
      - 'routes/**'
      - 'services/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Lint rápido (opcional)
        run: node -e "console.log('lint ok')"
      - name: Prueba arranque (smoke)
        run: node -e "require('fs').existsSync('./app.js') || process.exit(1)"

  cd:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Empaquetar artefacto
        run: |
          mkdir -p dist
          tar -czf dist/api.tar.gz app.js routes services package.json package-lock.json
      - uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: dist/api.tar.gz

      - name: Preparar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Copiar y desplegar en servidor
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          scp -o StrictHostKeyChecking=no dist/api.tar.gz $SSH_USER@$SSH_HOST:/tmp/api.tar.gz
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            mkdir -p ~/api-ia
            cd ~/api-ia
            tar -xzf /tmp/api.tar.gz -C .
            rm -f /tmp/api.tar.gz
            # Crear .env en el servidor (no lo subas al repo)
            cat > .env <<EOT
            API_TOKEN=${API_TOKEN}
            ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
            PORT=3000
            EOT
            # Instalar deps con Node 20 (asegúrate de tenerlo instalado)
            command -v node >/dev/null || curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - && sudo apt-get install -y nodejs
            npm ci --omit=dev
            npm i -g pm2
            pm2 delete api-ia || true
            pm2 start app.js --name api-ia --time
            pm2 save
          EOF
